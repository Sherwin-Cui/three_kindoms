# 草船借箭 - 核心机制文档

## 道具类型

道具按照是否可多次使用，可以分为一次性使用或重复使用，如“东吴虎符“是多次使用。”草人“是单词使用，用了就没了。

道具按功能和作用方式分为三个类别：
### 1. 剧情道具 (plot)
- **定义**：纯剧情物品，无直接数值效果
- **作用**：用于剧情展示和叙述，可作为AI剧情判断的条件依据
- **字段结构**：
  ```javascript
  {
    id: "itemId",
    name: "道具名称",
    type: "plot",
    description: "详细的剧情描述文本",
    effect: "纯剧情道具，可作为剧情条件"
  }
  ```
- **处理方式**：道具使用情况会进入对话历史和提示词，影响AI的剧情判断和推进
- **示例**：军令状、东吴虎符

### 2. 检定道具 (check)
- **定义**：影响检定数值计算的道具
- **作用**：为特定检定提供数值加成，影响成功率计算
- **字段结构**：
  ```javascript
  {
    id: "itemId",
    name: "道具名称", 
    type: "check",
    description: "道具的剧情描述",
    effect: {
      type: "checkBonus", // 或 "multiple"
      target: "属性名",
      value: 数值
    }
  }
  ```
- **处理方式**：系统读取effect字段参与检定计算，仅影响内部成功率，不产生UI数值变化显示
- **示例**：孔明羽扇、司南

### 3. 对话道具 (dialogue)
- **定义**：影响NPC属性的道具
- **作用**：直接增加或减少NPC的某种数值
- **字段结构**：
  ```javascript
  {
    id: "itemId",
    name: "道具名称",
    type: "dialogue", 
    description: "道具的剧情描述",
    effect: "自然语言描述道具作用，如：出示此信能够显著增加鲁肃对你的信任，鲁肃信任值+30"
  }
  ```
- **处理方式**：effect内容作为提示词发给AI，AI解析后输出相应的数值变化JSON
- **示例**：玄德亲笔、鲁肃举荐信



### 道具的使用方式

#### 1. 对话中使用
- **触发方式**：玩家从背包主动选择道具使用
- **处理逻辑**：道具效果被拼入Prompt，AI根据效果描述输出相应的数值变化JSON
- **消耗规则**：消耗性道具使用后立即从背包移除，记录到usedItems历史中

#### 2. 检定事件中使用
- **触发方式**：检定界面弹出时，系统显示可用的检定道具列表供玩家选择
- **处理逻辑**：道具的数值加成被系统应用到检定计算中（仅影响成功率）
- **使用限制**：无数量限制，玩家可选择使用任意数量的检定道具
- **消耗规则**：消耗性检定道具使用后移除，可重复道具保留

#### 3. 抉择事件中检查
- **检查方式**：系统检查玩家是否已使用过特定道具（usedItems历史）
- **显示逻辑**：满足条件的选项正常显示，不满足条件的选项置灰或隐藏
- **不可使用**：在抉择事件中无法直接使用道具





## 事件类型

游戏中的事件分为三种基本类型：

### 1. 对话事件 (dialogue_event)
- **作用**：纯剧情推进，不影响游戏数值
- **特点**：仅弹出对话窗口，展示剧情内容
- **触发**：完全由AI根据剧情发展决定
- **示例**：dialogue_event1, dialogue_event2

### 2. 抉择事件 (choice_event)
- **作用**：影响后续剧情走向，可能触发特定事件或数值变化
- **特点**：提供选项供玩家选择，不同选项导致不同结果
- **触发**：AI根据剧情节点和玩家行为决定
- **数值影响**：选项结果会明确标注数值变化，如"周瑜猜忌值+20"
- **示例**：choice_event1, choice_event2

### 3. 检定事件 (check_event)
- **作用**：进行数值计算和判定
- **特点**：基于玩家属性和道具加成进行成功/失败判定
- **触发**：AI识别需要检定的情况时触发
- **计算方式**：系统根据明确的数值公式计算，不依赖AI主观判断
- **示例**：check_event1, check_event3




## 事件后处理

### 1.对话事件
- 对话事件不会影响游戏数值，仅有一个展示的窗口，用户点下该窗口的“确认”按钮后，对话事件的内容会被作为对话历史的一部分拼入Prompt

### 2.抉择事件
- 抉择事件会对数值产生影响，也可能直接导向结局。
- **数值变化处理**：当用户选择带有数值影响标注的选项（如"周瑜猜忌值+20"）时，该选项内容会被拼入Prompt的"已完成事件"部分，AI根据标注输出对应的数值变化JSON，系统解析后在UI上显示数值变化。
- **直接结局处理**：某些选项会直接触发结局判定，系统立即显示结局界面，停止后续AI交互。

### 3. 检定事件
- **检定计算**：系统根据玩家属性、道具加成等进行成功率计算，得出成功/失败结果
- **结果处理**：检定结果（成功/失败）及其描述被拼入Prompt的"已完成事件"部分，AI根据结果输出相应的数值变化JSON




## 大语言模型负责的部分

### 输出数值变化情况
**核心原则**：大模型输出的JSON是UI数值变化显示的唯一途径

数值变化的三种触发方式：

1. **AI自主判断的属性变化**
   - AI根据剧情演绎和对话内容自主判断角色属性应如何变化
   - 通过value_changes字段输出具体数值变化

2. **玩家使用道具触发的数值变化**
   - 对话道具：AI根据道具effect的自然语言描述输出相应数值变化
   - 检定道具：仅参与内部检定计算，不产生UI数值变化
   - 剧情道具：通过影响AI判断间接产生数值变化

3. **事件结果触发的数值变化**
   - 抉择事件：选项的数值标注（如"周瑜猜忌值+20"）指导AI输出对应变化
   - 检定事件：检定结果描述指导AI输出相应的数值变化

**统一处理流程**：所有数值变化都必须通过AI输出JSON格式，系统解析后更新游戏状态并显示在UI上

### 给出事件触发
AI负责识别何时应该触发特定事件：
- **自主判断**：根据剧情发展和玩家行为判断合适的触发时机
- **框架指导**：章节梗概提供事件触发的时机建议，确保剧情按主线推进
- **输出方式**：通过event_suggestion字段输出事件ID和触发理由
- **平衡机制**：在遵循剧情框架的前提下，保持一定的随机性和灵活性





## 数值变化的唯一来源
### 模型给出











## 提示词构建机制

为确保AI有足够信息做出正确判断，提示词包含：

### 已发生事件部分
记录所有已完成的事件，包括：
- 事件名称和ID
- 事件类型和结果  
- 产生的数值影响
- 获得的道具

### 玩家使用道具信息部分
当玩家使用道具时，详细列出：
- 道具名称和ID
- 道具效果（根据类型适配）
- AI应该如何应用此效果

### 道具状态管理部分
为防止AI重复给出道具，提示词必须包含：
- **本章可获得道具列表**：列出当前章节设计中可以获得的所有道具及触发条件
- **已获得道具列表**：玩家当前拥有的所有道具（包括消耗性道具的剩余情况）
- **已使用道具历史**：记录所有已使用过的道具，防止消耗性道具重复获得
- **道具获得条件检查**：明确每个道具的获得条件是否已满足

### 事件状态管理部分
为确保事件触发的完整性和避免重复，提示词必须包含：
- **本章应触发事件列表**：当前章节设计的所有事件及其触发时机
- **已触发事件列表**：记录所有已经触发过的事件ID
- **事件触发条件状态**：各个事件的触发条件当前是否满足
- **章节进度追踪**：当前章节的完成度和下一步应该推进的方向

## 失败结局判定

### 某数值判定
某数值到达一定程度自动触发结局
- 由系统代码直接判定，无需AI参与
- 明确的数值阈值（如周瑜猜忌值≥100）

### 选项判定
某些选项直接导向结局
- 特定的抉择事件选项直接触发失败结局
- 系统根据选项ID判定

## 成功结局判定
只能是大模型判定，这样才能保证剧情的连贯性，模型给出收束性的发言之后，触发结局。不会有体验上的割裂感。
- AI在剧情自然收束时判断成功条件达成
- 通过gameEndJudgment字段输出结局判定






## 检定事件的计算规则

### 基础计算公式
检定事件采用属性值 + 道具加成 - 难度值的计算方式：

```
事件难度值 = 100 - (事件的baseSuccessRate || 50)
成功率 = Math.max(0, Math.min(100, 玩家属性值 + 道具加成 - 事件难度值))
随机值 = Math.random() * 100
检定结果 = 随机值 < 成功率
```

### 属性值获取
- **智谋检定**：使用角色的intelligence属性值
- **口才检定**：使用角色的eloquence属性值  
- **其他检定**：根据checkType字段确定对应属性

### 道具加成计算
- 系统遍历玩家拥有的检定道具
- 匹配道具effect.target与检定类型
- 累加所有匹配道具的effect.value值
- 消耗性道具使用后不再提供加成

### 难度值设定（建议统一为successThreshold）
- **推荐方式**：统一使用`successThreshold`字段
  - `难度值 = 100 - successThreshold`
  - 语义更清晰：直接表示需要达到的成功阈值
  - 如果未设定successThreshold，默认使用50
- **代码修改**：将gameEngine.js中的baseSuccessRate改为successThreshold
- **设定原则**：
  - successThreshold为70时，难度值为30，相对容易
  - successThreshold为30时，难度值为70，相对困难
  - 玩家属性值通常在50-90之间，道具可提供10-30加成

### 特殊检定结果
- **大成功**：随机值 ≥ 90 且检定成功时触发
- **大失败**：随机值 ≤ 10 且检定失败时触发
- 特殊结果会影响后续的奖励和惩罚

### 检定结果的后续处理
1. **成功结果**：触发successEffects中定义的效果，AI根据successText输出数值变化
2. **失败结果**：触发failureEffects中定义的效果，AI根据failureText输出数值变化
3. **状态记录**：系统记录事件的成功/失败状态，供后续逻辑参考









## 字段优化原则

### 架构原则
- **数值变化用自然语言**：复杂的逻辑关系用自然语言描述，供AI理解
- **系统处理用明确变量**：需要程序计算的部分使用明确的数值字段

### 需要保留的字段
基于架构原则，事件对象应保留的核心字段：
1. **基础信息字段**：id, name, type, description
2. **功能性字段**：content, checkTarget, successThreshold, consequences

### 可以删除的字段
根据原则可以简化的字段：
1. **复杂的条件字段**：conditions（复杂触发条件对象）
2. **复杂的计算公式**：formula（过度细化的计算规则）
3. **冗余字段**：如triggerCondition（AI通过自然语言理解触发时机）

## 完整游玩流程关键检查点

### 玩家交互流程图
```
1. 玩家发言
   ↓
2. AI处理并输出JSON
   ↓
3. 系统解析数值变化 → UI更新数值显示
   ↓
4. 检查事件触发 → 弹出事件界面
   ↓
5. 处理事件结果
   ├─ 对话事件 → 点击确认 → 内容进入历史
   ├─ 抉择事件 → 选择选项 → 结果进入历史
   └─ 检定事件 → 选择道具 → 执行检定 → 结果进入历史
   ↓
6. 检查道具触发 → 背包更新
   ↓
7. 检查结局条件
   ├─ 继续游戏 → 返回步骤1
   └─ 触发结局 → 显示结局界面
```

### 关键实现检查点

#### 1. 道具系统完整性
- [ ] 检定事件中的道具选择UI实现
- [ ] 消耗性道具使用后的状态清理
- [ ] 道具使用历史的正确记录
- [ ] 重复道具获得的防护机制

#### 2. 事件系统完整性  
- [ ] 事件触发条件的准确判断
- [ ] 事件状态的正确记录和传递
- [ ] 章节切换时事件状态的处理
- [ ] AI重复触发事件的防护机制

#### 3. 状态同步完整性
- [ ] 数值变化的UI实时更新
- [ ] 章节切换时状态的正确继承
- [ ] 道具状态在不同章节间的传递
- [ ] 对话历史的完整保存和传递

#### 4. AI交互完整性
- [ ] 提示词中状态信息的完整性
- [ ] AI输出JSON的格式验证
- [ ] AI判断逻辑的一致性检查
- [ ] 异常情况的容错处理

## 总结

本架构的核心是通过合理分工实现灵活且可控的游戏机制：
- **AI处理**：自然语言逻辑理解、剧情判断、数值变化输出、事件触发建议
- **系统处理**：明确数值计算、阈值判定、数据更新、状态同步、UI交互
- **关键原则**：确保每个交互环节都有明确的实现方案，避免功能缺失导致的游戏体验中断
- **目标**：构建完整闭环的游戏系统，保证玩家能够顺利完成整个游戏流程

## 立即需要实施的改进

### 1. 代码层面修复
```javascript
// gameEngine.js 第199行
// 修改前：
const difficulty = 100 - (eventData.baseSuccessRate || 50);
// 修改后：
const difficulty = 100 - (eventData.successThreshold || 50);
```

### 2. UI功能补充
- **检定事件道具选择界面**：在check事件触发时弹出道具选择窗口
- **道具使用确认机制**：特别是消耗性道具的使用确认
- **状态变化动画**：数值变化的视觉反馈

### 3. promptBuilder增强
需要在提示词中添加以下部分：
```javascript
// 本章可获得道具状态
buildChapterItemStatus(chapterId, gameState) {
  // 返回：可获得道具列表、已获得道具、获得条件检查
}

// 本章事件进度状态  
buildChapterEventStatus(chapterId, gameState) {
  // 返回：应触发事件列表、已触发事件、触发条件状态
}
```

### 4. 状态管理完善
- **道具使用历史追踪**：确保usedItems正确记录和传递
- **章节状态继承**：道具、数值、历史的正确传递
- **异常状态恢复**：AI输出异常时的容错机制

### 5. 测试验证清单
- [ ] 第一章完整通关测试
- [ ] 道具使用各种场景测试  
- [ ] 章节切换状态继承测试
- [ ] AI重复道具/事件防护测试
- [ ] 异常情况容错测试